# Task 7: Keyboard Navigation System

**Epic**: menu-interface  
**Created**: 2025-09-03T18:46:59Z  
**Updated**: 2025-09-04T12:38:33Z  
**GitHub**: https://github.com/AngelOnFira/macroquad-mech-2025/issues/7  
**Status**: planned  
**Priority**: medium  
**Effort**: 6 hours  
**Depends On**: [5]  
**Parallel**: true  

## Overview

Implement comprehensive WASD + Enter keyboard navigation for the menu system, extending existing InputHandler patterns to provide seamless navigation without mouse dependency. This enhances accessibility and provides a console-like navigation experience.

## Objectives

- Enable full menu navigation using WASD keys and Enter
- Integrate with existing InputHandler architecture
- Implement focus management system for egui widgets  
- Provide visual feedback for focused elements
- Support both sequential and spatial navigation patterns

## Technical Requirements

### Navigation Patterns

1. **Sequential Navigation** (Tab-like)
   - W/S: Previous/Next focusable element
   - Enter: Activate focused element
   - Escape: Close/Back navigation

2. **Spatial Navigation** (Grid-like)
   - WASD: Navigate in 2D space between elements
   - Smart focus jumping based on element positions
   - Wrapping behavior at boundaries

3. **Hierarchical Navigation**
   - Enter: Descend into submenu/category
   - Escape: Return to parent menu/category
   - Breadcrumb-style navigation memory

### Core Components

1. **MenuNavigationState**
   ```rust
   pub struct MenuNavigationState {
       focused_element: Option<ElementId>,
       navigation_mode: NavigationMode,
       focus_history: Vec<FocusState>,
       last_input_method: InputMethod,
   }
   
   pub enum NavigationMode {
       Sequential,  // Tab-like, for lists
       Spatial,     // Grid-like, for 2D layouts  
       Tree,        // Hierarchical, for settings
   }
   ```

2. **FocusManager**
   ```rust
   pub struct FocusManager {
       focusable_elements: Vec<FocusableElement>,
       current_focus: usize,
       navigation_map: HashMap<ElementId, NavigationEdges>,
   }
   
   pub struct NavigationEdges {
       up: Option<ElementId>,
       down: Option<ElementId>,
       left: Option<ElementId>,
       right: Option<ElementId>,
   }
   ```

3. **KeyboardInputExtension**
   ```rust
   pub trait KeyboardNavigable {
       fn handle_navigation_input(&mut self, input: &NavigationInput) -> NavigationResult;
       fn get_focusable_elements(&self) -> Vec<FocusableElement>;
       fn set_focus(&mut self, element_id: ElementId);
   }
   ```

### Integration with Existing Systems

- Extend `InputHandler` to include navigation events
- Add navigation state to `MenuState` variants
- Integrate with egui's focus system where possible
- Maintain compatibility with mouse navigation

## Implementation Plan

### Phase 1: Core Navigation Framework (2 hours)
1. Define navigation data structures and enums
2. Extend InputHandler with keyboard navigation events
3. Create basic FocusManager with sequential navigation
4. Add focus state to main menu structure

### Phase 2: Visual Focus System (2 hours)
1. Implement focus highlighting for menu elements
2. Create consistent focus indicators across different widget types
3. Add smooth focus transitions and animations
4. Integrate with existing egui styling

### Phase 3: Advanced Navigation Modes (1.5 hours)
1. Implement spatial navigation for grid-like layouts
2. Add hierarchical navigation for settings tree
3. Smart focus prediction and wrapping behavior
4. Navigation memory and history management

### Phase 4: Integration & Polish (0.5 hours)
1. Connect to all menu states (Main, Pause, Settings, Join)
2. Add audio feedback for navigation events
3. Performance optimization for focus calculations
4. Accessibility improvements and testing

## Acceptance Criteria

### Core Navigation
- [ ] WASD keys navigate between menu elements
- [ ] Enter key activates focused menu item
- [ ] Escape key provides back/cancel functionality
- [ ] Focus wraps appropriately at menu boundaries
- [ ] Navigation works in all menu states (Main, Pause, Settings, Join)

### Visual Feedback
- [ ] Focused elements have clear visual indication
- [ ] Focus transitions are smooth and non-jarring
- [ ] Focus indicator style is consistent across menu types
- [ ] Focus remains visible when navigating quickly
- [ ] Current focus survives menu state transitions where logical

### Integration Requirements
- [ ] Mouse navigation continues to work unchanged
- [ ] Keyboard navigation doesn't interfere with in-game controls
- [ ] Focus automatically moves to appropriate element when menus open
- [ ] Navigation state persists across menu transitions
- [ ] Settings menu navigation works with hierarchical categories

### Accessibility
- [ ] All interactive elements are reachable via keyboard
- [ ] Focus order follows logical visual flow
- [ ] Navigation shortcuts are discoverable
- [ ] Focus indicators meet contrast requirements
- [ ] Navigation provides audio feedback where appropriate

## Testing Strategy

### Unit Tests
- FocusManager element registration and focus changes
- Navigation input processing and state updates
- Focus history management and navigation memory
- Edge case handling (empty menus, single elements)

### Integration Tests  
- Navigation across different menu states
- Focus preservation during menu transitions
- Keyboard/mouse input mode switching
- Settings menu tree navigation

### Manual Testing Scenarios
1. Navigate entire main menu using only keyboard
2. Open settings, navigate categories without mouse
3. Switch between keyboard and mouse mid-navigation
4. Test navigation with different window sizes
5. Verify focus indicators in high contrast mode
6. Test rapid navigation input handling

## Known Challenges

### Technical Challenges
- **egui Integration**: Working with egui's existing focus system
- **State Persistence**: Maintaining focus across menu changes
- **Input Conflicts**: Avoiding conflicts with game controls
- **Performance**: Efficient focus calculations for large menus

### UX Challenges
- **Focus Prediction**: Where to move focus when current element disappears
- **Navigation Shortcuts**: Balancing power user features with simplicity
- **Visual Clarity**: Making focus indicators clear without being distracting
- **Mode Switching**: Seamless transition between keyboard and mouse

## Dependencies

- **Task 5 (Main Menu)**: Provides menu structure and states to navigate
- **Existing InputHandler**: Foundation for input processing extension
- **egui framework**: Widget focus system and event handling
- **Current menu layouts**: Understanding element positioning for spatial navigation

## Success Metrics

- Complete menu navigation possible without mouse
- Focus indicators provide clear visual guidance
- Navigation feels responsive and predictable
- No performance impact when keyboard navigation is inactive
- Accessibility guidelines met for keyboard-only users

## Future Extensions

- **Custom Key Bindings**: Allow users to customize navigation keys
- **Navigation Shortcuts**: Direct jump keys for common menu items  
- **Gamepad Support**: Extend navigation to controller d-pad/sticks
- **Voice Commands**: Voice activation integration for navigation
- **Navigation Help**: In-menu guidance for keyboard shortcuts